source("global.R", local = T)
source("kriging_slicewise.R", local = T)

#### UI ####
ui <- fluidPage(
  
  navbar <- navbarPage(
    title = "Uncertainty Viz in ECV Forecasts",
    id = "navbar",
    
    # Page 0 "Home" content
    tabPanel(title = "Home", value = "tab0",
             
             mainPanel(
               img(src="https://icisk.eu/wp-content/uploads/2022/01/icisk_logo_full.png", style = "height: 50%; width: 50%; margin: 1px 1px;"),
               h1("Uncertainty visualization questionnaire"),
               p("This webpage exhibits some examples for the visualization of uncertainty in temperature and precipitation forecasts for Living Lab Andalusia in Spain 🇪🇸 in the I-CISK project."),
               p("Navigate through the top bar to explore the different visualizations. You use these later for the questionnaire.")
             )),
    
    # Page 1 "Map 1" content
    tabPanel( title = "Map 1", value = "tab1",
              mainPanel(
                h1("Hypothetical Outcome Map"),
                p("This page depicts possible outcomes of the temperature forecast for the next year. Click on the play-button ▶️️ in the slider to view the animation."),
                sliderInput("year", "Select Year", min = years[1], max = years[length(years)], step = 1, value = years[1], animate = animationOptions(interval = 800, loop = TRUE)),
                leafletOutput("map")
              )),
    
    # Page 2 "Map 2" content
    tabPanel( title = "Map 2", value = "tab2",
              mainPanel(
                p("This page depicts two maps: the left one displays the temperature forecast for the selected year.
                  The map on the right shows the associated uncertainty of the forecast.
                  Pick a year to display in the slider below.")),
              sliderInput("year2", "Select Year", min = years[1], max = years[length(years)], step = 1, value = years[1]),
              column(width = 6, h1("Forecast"), leafletOutput("map2_1")),
              column(width = 6, h1("Forecast Uncertainty"), leafletOutput("map2_2"))
    ),
    # Page 3 "Map 3" content
    tabPanel( title = "Map 3", value = "tab3",
              mainPanel(
                p("This page depicts possible outcomes of the temperature forecast for the next year.")),
              p("Lowest temp"),
              p("Highest temp")
    ),
    
    # Page 4 "Map 4" content
    tabPanel( title = "Map 4", value = "tab4",
              mainPanel(
                p("This page depicts possible outcomes of the temperature forecast for the next year."))
    )
    
  ) # close navbarpage
) # close UI

#### Server ####
server <- function(input, output, session) {
  # Create initial map 1
  output$map <- renderLeaflet({
    year <- years[1]
    map_data <- get(paste0("kriged_slices_", year))
    leaflet() |>
      addProviderTiles(providers$CartoDB.Positron) |>
      addMouseCoordinates() |>
      addStarsImage(map_data["mean_temp_pred", , , 6], layerId = "Temperature", colors = pal, opacity = 0.7) |>
      addLegend(pal = pal, values = 18:30, title = "Temperature (°C)", position = "bottomright", opacity = 1) |>
      addPolygons(data = spain_LL, fill = FALSE, color = "red", weight = 2)
  })
  
  # Use observeEvent to update the layer when the input changes
  # corresponds to above map 1
  observeEvent(input$year, {
    year <- input$year
    map_data <- get(paste0("kriged_slices_", year))
    leafletProxy("map", data = map_data) |>
      clearGroup("Temperature") |>  # Clear the existing starsImage layer
      #clearControls() |> # Clear the legend
      addStarsImage(map_data["mean_temp_pred", , , 6], layerId = "Temperature", colors = pal, opacity = 0.7)
    #addLegend(pal = pal, values = 20:25, title = "Temperature", position = "bottomright")
  })
  
  output$map2_1 <- renderLeaflet({
    year <- years[1]
    map_data <- get(paste0("kriged_slices_", year))
    leaflet() |>
      addProviderTiles(providers$CartoDB.Positron) |>
      addMouseCoordinates() |>
      addStarsImage(map_data["mean_temp_pred", , , 6], layerId = "Temperature", colors = pal, opacity = 0.7) |>
      addLegend(pal = pal, values = 18:30, title = "Temperature (°C)", position = "bottomright", opacity = 1) |>
      addPolygons(data = spain_LL, fill = FALSE, color = "red", weight = 2)
  })

  output$map2_2 <- renderLeaflet({
    year <- years[1]
    map_data <- get(paste0("kriged_slices_", year))
    leaflet() |>
      addProviderTiles(providers$CartoDB.Positron) |>
      addMouseCoordinates() |>
      addStarsImage(map_data["mean_temp_difference", , , 6], layerId = "Temperature", colors = pal2, opacity = 0.7) |>
      addLegend(pal = pal2, values = 0.3:4.3, title = "Possible difference (°C)", position = "bottomright", opacity = 1) |>
      addPolygons(data = spain_LL, fill = FALSE, color = "red", weight = 2)
  })
  
  observeEvent(input$year2, {
    year <- input$year2
    map_data <- get(paste0("kriged_slices_", year))
    # update left map2_1 based on new input
    leafletProxy("map2_1", data = map_data) |>
      clearGroup("Temperature") |>  
      addStarsImage(map_data["mean_temp_pred", , , 6], layerId = "Temperature", colors = pal, opacity = 0.7)
    # update right map2_2 based on new input
    leafletProxy("map2_2", data = map_data) |>
      clearGroup("Temperature") |>  
      addStarsImage(map_data["mean_temp_difference", , , 6], layerId = "Temperature", colors = pal2, opacity = 0.7)
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
